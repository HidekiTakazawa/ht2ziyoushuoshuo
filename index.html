<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>ğŸ¼ è‡ªç”±è¯´ä¸­æ–‡ - Speak Chinese Freely!</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'M PLUS Rounded 1c', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      padding: 1em;
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      position: relative;
      color: #333;
      margin: 0;
    }

    /* èƒŒæ™¯ç”»åƒã‚’è–„ãã™ã‚‹ãŸã‚ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.6); /* ç™½è‰²ã®åŠé€æ˜ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é€æ˜åº¦ã‚’èª¿æ•´ */
      z-index: -1;
    }

    .container {
      max-width: 800px;
      margin: 2em auto;
      padding: 2em;
      background-color: transparent; /* ãƒ‘ãƒ³ãƒ€ç”»åƒã‚’é€éã•ã›ã‚‹ãŸã‚ */
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      position: relative; /* ::afteræ“¬ä¼¼è¦ç´ ã®åŸºæº–ä½ç½® */
      z-index: 1; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒ::afterã®ä¸Šã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã« */
    }

    /* ã‚³ãƒ³ãƒ†ãƒŠå†…éƒ¨ã«è–„ã„ãƒ‘ãƒ³ãƒ€ç”»åƒã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .container::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.6); /* ç™½è‰²ã®åŠé€æ˜ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é€æ˜åº¦ã‚’èª¿æ•´ */
      z-index: -1; /* ã‚³ãƒ³ãƒ†ãƒŠã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®èƒŒé¢ã«é…ç½® */
      border-radius: 15px; /* ã‚³ãƒ³ãƒ†ãƒŠã®è§’ä¸¸ã«åˆã‚ã›ã‚‹ */
    }

    h2, h3 {
      font-size: 1.8em;
      text-align: center;
    }

    h2 {
      color: rgb(0, 128, 122);
      margin-top: 0.5em;
      margin-bottom: 0.5em;
    }

    h3 {
      margin-top: 1em;
      font-size: 1.2em;
      color: #555;
      font-weight: 400;
    }

    .controls {
      text-align: center;
      margin-bottom: 1.5em;
    }

    button {
      font-size: 24px;
      padding: 10px 20px;
      margin-right: 10px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    button:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }

    .result-item .chinese {
      font-size: 22px;
      font-weight: bold;
      margin: 5px 0;
    }

    .result-item .pinyin {
      font-size: 18px;
      color: #555;
      margin: 5px 0;
    }

    #show_progress {
      width: 90%;
      font-size: 18px;
      color: #888;
    }
    
    #start_btn {
      background-color: #28a745;
      color: white;
    }
    #start_btn:hover:not(:disabled) {
      background-color: #218838;
      transform: translateY(-2px);
    }

    #stop_btn {
      background-color: #dc3545;
      color: white;
    }
    #stop_btn:hover:not(:disabled) {
      background-color: #c82333;
      transform: translateY(-2px);
    }

    #copy_btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      vertical-align: middle;
      box-shadow: none;
    }
    #copy_btn svg {
      width: 32px;
      height: 32px;
      fill: #6c757d;
      transition: fill 0.2s ease;
    }
    #copy_btn:hover svg {
      fill: #007bff;
    }
    #copy_message {
      color: #28a745;
      font-weight: bold;
      margin-left: 10px;
    }

    #show_result .result-item {
      background-color: #fff;
      border-radius: 8px;
      margin-bottom: 10px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>è‡ªç”±è¯´ä¸­æ–‡</h2>
    <h3>â˜[start]ã‚’æŠ¼ã—ã¦ç™ºéŸ³ã™ã‚‹ã¨ç°¡ä½“å­—ãƒ»ãƒ”ãƒ³ã‚¤ãƒ³ã«å¤‰æ›ã—ã¾ã™</h3>
    <h3>çµ‚äº†ã™ã‚‹æ™‚ã¯[stop]ã‚’æŠ¼ã—ã¦ãã ã•ã„</h3>
    <div class="controls">
      <button id="start_btn">start</button>
      <button id="stop_btn" disabled>stop</button>
      <button id="copy_btn" title="å±¥æ­´ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
      </button>
      <span id="copy_message"></span>
    </div>
    <small id="status"></small>
    <h3>èªè­˜ä¸­ã®ãƒ†ã‚­ã‚¹ãƒˆ</h3>
    <textarea id="show_progress" cols="100" rows="1" readonly></textarea>
    <h3>å¤‰æ›çµæœ
    </h3>
    <div id="show_result"></div>
  </div>
</body>
<!-- è¾æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ -->
<script type="text/javascript" src="dict/pinyin_dict_withtone.js"></script>
<script type="text/javascript" src="dict/pinyin_dict_polyphone.js"></script>
<script type="text/javascript" src="pinyinUtil.js"></script>

<script>
  // --- â˜…ãƒ‡ã‚¶ã‚¤ãƒ³å¤‰æ›´ï¼šèƒŒæ™¯ç”»åƒã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¨­å®š ---
  document.addEventListener('DOMContentLoaded', function() {
    const pandas = [
      'https://images.unsplash.com/photo-1564349683136-77e08dba1ef7?q=80&w=2072&auto=format&fit=crop',
      'https://images.unsplash.com/photo-1527118732049-c88155f2107c?q=80&w=1887&auto=format&fit=crop',
      'https://images.unsplash.com/photo-1559703248-dca719707d39?q=80&w=1887&auto=format&fit=crop',
      'https://images.unsplash.com/photo-1589932838497-28b368a454c7?q=80&w=1887&auto=format&fit=crop',
      'https://images.unsplash.com/photo-1570288685280-7802a8f8c4fa?q=80&w=1887&auto=format&fit=crop'
    ];
    const randomIndex = Math.floor(Math.random() * pandas.length);
    document.body.style.backgroundImage = `url('${pandas[randomIndex]}')`;
  });
  // --- â˜…ãƒ‡ã‚¶ã‚¤ãƒ³å¤‰æ›´ã“ã“ã¾ã§ ---

  // Ensure browser compatibility for the SpeechRecognition API
  window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (window.SpeechRecognition) {
    const recognition = new SpeechRecognition();

    // Web Speech API Configuration
    recognition.lang = 'zh-CN'; // Mandarin (China)
    recognition.interimResults = true;
    recognition.continuous = true;

    // Get DOM elements
    const startBtn = document.getElementById('start_btn');
    const stopBtn = document.getElementById('stop_btn');
    const copyBtn = document.getElementById('copy_btn');
    const copyMessage = document.getElementById('copy_message');
    const progressTextarea = document.getElementById('show_progress');
    const resultDiv = document.getElementById('show_result');
    const statusSpan = document.getElementById('status');

    recognition.onsoundstart = function () {
      statusSpan.textContent = "èªè­˜ä¸­...";
    };
    recognition.onnomatch = function () {
      statusSpan.textContent = "èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
    };
    recognition.onerror = function (event) {
      statusSpan.textContent = "ã‚¨ãƒ©ãƒ¼: " + event.error;
    };
    recognition.onsoundend = function () {
      statusSpan.textContent = "å¾…æ©Ÿä¸­...";
    };

    startBtn.addEventListener('click', function () {
      recognition.start();
      this.disabled = true;
      stopBtn.disabled = false;
      statusSpan.textContent = "ãƒã‚¤ã‚¯ã«è©±ã—ã‹ã‘ã¦ãã ã•ã„...";
    });

    stopBtn.addEventListener('click', function () {
      recognition.stop();
      this.disabled = true;
      startBtn.disabled = false;
      progressTextarea.value = '';
      statusSpan.textContent = "åœæ­¢ã—ã¾ã—ãŸã€‚";
    });

    // --- â˜…å¤‰æ›´ç‚¹ï¼šã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã®å‡¦ç† ---
    copyBtn.addEventListener('click', function() {
      // å±¥æ­´è¡¨ç¤ºã‚¨ãƒªã‚¢ã‹ã‚‰ã™ã¹ã¦ã®çµæœã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—
      const resultItems = resultDiv.querySelectorAll('.result-item');
      
      // å±¥æ­´ãŒç©ºã®å ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ã¦å‡¦ç†ã‚’çµ‚äº†
      if (resultItems.length === 0) {
        alert('ã‚³ãƒ”ãƒ¼ã™ã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
        return;
      }

      let historyText = '';
      resultItems.forEach(item => {
        const chinese = item.querySelector('.chinese').textContent;
        const pinyin = item.querySelector('.pinyin').textContent;
        // ã€Œç°¡ä½“å­—(æ”¹è¡Œ)ãƒ”ãƒ³ã‚¤ãƒ³(æ”¹è¡Œ)(æ”¹è¡Œ)ã€ã®å½¢å¼ã§ãƒ†ã‚­ã‚¹ãƒˆã‚’çµåˆ
        historyText += `${chinese}\n${pinyin}\n\n`;
      });

      // æ•´å½¢ã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
      navigator.clipboard.writeText(historyText.trim()).then(() => {
        copyMessage.textContent = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
        this.disabled = true; // é€£æ‰“é˜²æ­¢
        
        setTimeout(() => {
          copyMessage.textContent = '';
          this.disabled = false;
        }, 1500);
      }).catch(err => {
        console.error('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ', err);
        alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      });
    });
    // --- â˜…å¤‰æ›´ç‚¹ã“ã“ã¾ã§ ---

    // èªè­˜ãŒï¼ˆã‚¨ãƒ©ãƒ¼ã‚„ç„¡éŸ³ãªã©ã§ï¼‰çµ‚äº†ã—ãŸéš›ã«è‡ªå‹•ã§å†é–‹ã™ã‚‹ãŸã‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    recognition.onend = function () {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§stopãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã„ãªã„å ´åˆã®ã¿å†é–‹ã™ã‚‹
      if (!stopBtn.disabled) {
        recognition.start();
      }
    };

    let lastFinalTranscript = ''; // æœ€å¾Œã«ç¢ºå®šã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿å­˜ã™ã‚‹å¤‰æ•°

    recognition.onresult = function (event) {
      let interimTranscript = '';
      for (let i = event.resultIndex; i < event.results.length; ++i) {
        const transcript = event.results[i][0].transcript;
        if (event.results[i].isFinal) {
          // æœ€çµ‚çµæœãŒå‰å›ã¨ç•°ãªã‚Šã€ã‹ã¤ç©ºã§ãªã„å ´åˆã®ã¿å‡¦ç†
          if (transcript.trim() && transcript !== lastFinalTranscript) {
            lastFinalTranscript = transcript; // ä»Šå›ã®çµæœã‚’ä¿å­˜

            // ãƒ”ãƒ³ã‚¤ãƒ³ã«å¤‰æ›
            const pinyin = pinyinUtil.getPinyin(transcript, ' ', true, true, true);

            // è¡¨ç¤ºç”¨ã®è¦ç´ ã‚’ä½œæˆ
            const resultItem = document.createElement('div');
            resultItem.className = 'result-item';
 
            const chineseP = document.createElement('p');
            chineseP.className = 'chinese';
            chineseP.textContent = transcript;
 
            const pinyinP = document.createElement('p');
            pinyinP.className = 'pinyin';
            pinyinP.textContent = pinyin;
 
            resultItem.appendChild(chineseP);
            resultItem.appendChild(pinyinP);
            // æ–°ã—ã„çµæœã‚’ä¸€ç•ªä¸Šã«è¡¨ç¤º
            resultDiv.prepend(resultItem);
          }
          // é€”ä¸­çµæœè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
          progressTextarea.value = '';
          interimTranscript = '';
        } else {
          interimTranscript += transcript;
        }
      }
      progressTextarea.value = interimTranscript;
    }
  } else {
    document.body.innerHTML = "<div class='container'><h2>ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯Web Speech APIã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚Google Chromeã‚’ãŠè©¦ã—ãã ã•ã„ã€‚</h2></div>";
  }
</script>

</html>